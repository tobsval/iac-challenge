---
# https://docs.docker.com/engine/security/protect-access/#use-tls-https-to-protect-the-docker-daemon-socket
- name: Take necessary steps to secure dockerd over HTTPS
  hosts: all
  become: true
  gather_facts: false
  tasks:
  # Setup tasks
  - name: Install PyOpenSSL
    pip:
      name: PyOpenSSL==20.0.1

  - name: Obtain IPv4 address of VM
    shell: "set -o pipefail && ip addr | grep 192 | awk '{print $2}' | sed 's/...$//'"
    register: ipv4_out
    changed_when: "ipv4_out.rc != 2"

  - name: Obtain VM Hostname
    command: "hostname"
    register: hostname_out
    changed_when: "hostname_out.rc != 2"

  # Crypto tasks
  - name: Generate CA private key (4096 bits, RSA)
    community.crypto.openssl_privatekey:
      path: /etc/ssl/docker-ca-priv.pem

  - name: Generate CA public key (4096 bits, RSA)
    community.crypto.openssl_publickey:
      path: /etc/ssl/docker-ca-pub.pem
      privatekey_path: /etc/ssl/docker-ca-priv.pem

  - name: Generate server private key (4096 bits, RSA)
    community.crypto.openssl_privatekey:
      path: /etc/ssl/docker-srv-priv.pem

  - name: Generate OpenSSL cert sign request
    community.crypto.openssl_csr:
      path: /etc/ssl/docker-server.csr
      privatekey_path: /etc/ssl/docker-srv-priv.pem
      common_name: "{{ out.stdout }}"

  - name: Add extfile
    template:
      src: extfile-srv.cnf
      dest: /etc/ssl
      mode: '0777'
